// ==UserScript==
// @name         FS-Sign –í—ã–≥—Ä—É–∑–∫–∞ Downloader - XLSX/JSON
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  –í—ã–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å FSign –≤ XLSX –∏ JSON —Ñ–æ—Ä–º–∞—Ç–∞—Ö
// @author       You
// @match        https://sign.fsdocs.kz/contracts*
// @grant        GM_addStyle
// @require      https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js
// ==/UserScript==

(function() {
    'use strict';

    // –°—Ç–∏–ª–∏ –¥–ª—è UI
    GM_addStyle(`
        .fsign-downloader {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(0, 123, 255, 0.5);
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: Arial, sans-serif;
            min-width: 200px;
            backdrop-filter: blur(5px);
        }
        .fsign-downloader h3 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #333;
            border-bottom: 1px solid #007bff;
            padding-bottom: 5px;
        }
        .fsign-btn {
            width: 100%;
            padding: 6px;
            margin: 3px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .fsign-btn-primary {
            background: #007bff;
            color: white;
        }
        .fsign-btn-primary:hover {
            background: #0056b3;
        }
        .fsign-btn-success {
            background: #28a745;
            color: white;
        }
        .fsign-btn-success:hover {
            background: #218838;
        }
        .fsign-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .fsign-status {
            margin-top: 6px;
            padding: 5px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 4px;
            font-size: 10px;
            color: #666;
            text-align: center;
        }
        .fsign-progress {
            margin-top: 6px;
            height: 16px;
            background: rgba(233, 236, 239, 0.8);
            border-radius: 8px;
            overflow: hidden;
        }
        .fsign-progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
    `);

    // –°–æ–∑–¥–∞–Ω–∏–µ UI
    const ui = document.createElement('div');
    ui.className = 'fsign-downloader';
    ui.innerHTML = `
        <h3>üì• FSign –í—ã–≥—Ä—É–∑–∫–∞</h3>
        <button class="fsign-btn fsign-btn-primary" id="fsign-collect">–°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button class="fsign-btn fsign-btn-success" id="fsign-xlsx" disabled>–°–∫–∞—á–∞—Ç—å XLSX</button>
        <button class="fsign-btn fsign-btn-success" id="fsign-json" disabled>–°–∫–∞—á–∞—Ç—å JSON</button>
        <div class="fsign-progress" id="fsign-progress" style="display:none;">
            <div class="fsign-progress-bar" id="fsign-progress-bar">0%</div>
        </div>
        <div class="fsign-status" id="fsign-status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
    `;
    document.body.appendChild(ui);

    let collectedData = [];

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function getLastPage() {
        const lastLink = document.querySelector('.pagi a[href*="–ü–æ—Å–ª"]');
        if (lastLink) {
            const match = lastLink.getAttribute('href').match(/page=(\d+)/);
            return match ? parseInt(match[1]) : 1;
        }
        return 1;
    }

    // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function parsePageData() {
        const rows = document.querySelectorAll('.table.table-striped tbody tr');
        const data = [];

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 5) {
                const docInfo = cells[0].textContent.trim().split('\n').filter(s => s.trim());
                const stageInfo = cells[1].textContent.trim().split('\n').filter(s => s.trim());
                const initiator = cells[2].textContent.trim();
                const addressee = cells[3].textContent.trim().split('\n').filter(s => s.trim());
                const dates = cells[4].textContent.trim().split('\n').filter(s => s.trim());

                data.push({
                    '–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞': docInfo[0] || '',
                    '–ù–∞–∑–≤–∞–Ω–∏–µ': docInfo[1] || '',
                    '–°—Ç–∞–¥–∏—è': stageInfo[0] || '',
                    '–°—Ç–∞—Ç—É—Å': stageInfo[1] || '',
                    '–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞': stageInfo[2] || '',
                    '–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä': initiator,
                    '–ê–¥—Ä–µ—Å–∞—Ç': addressee[0] || '',
                    '–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ': addressee[1] || '',
                    '–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞': dates[0] || '',
                    '–î–∞—Ç–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏': dates[1] || ''
                });
            }
        });

        return data;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    function updateProgress(current, total) {
        const percent = Math.round((current / total) * 100);
        const progressBar = document.getElementById('fsign-progress-bar');
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
    }

    // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
    async function collectAllData() {
        const collectBtn = document.getElementById('fsign-collect');
        const xlsxBtn = document.getElementById('fsign-xlsx');
        const jsonBtn = document.getElementById('fsign-json');
        const status = document.getElementById('fsign-status');
        const progress = document.getElementById('fsign-progress');

        collectBtn.disabled = true;
        xlsxBtn.disabled = true;
        jsonBtn.disabled = true;
        progress.style.display = 'block';
        collectedData = [];

        const lastPage = getLastPage();
        status.textContent = `–ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: ${lastPage}`;

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç 1 –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π
        for (let page = 1; page <= lastPage; page++) {
            try {
                status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${page}/${lastPage}...`;

                let html;
                if (page === 1) {
                    // –î–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π DOM
                    html = document.documentElement.outerHTML;
                } else {
                    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
                    const response = await fetch(`https://sign.fsdocs.kz/contracts?page=${page}`);
                    html = await response.text();
                }

                // –ü–∞—Ä—Å–∏–º HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const rows = tempDiv.querySelectorAll('.table.table-striped tbody tr');

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 5) {
                        const docInfo = cells[0].textContent.trim().split('\n').filter(s => s.trim());
                        const stageInfo = cells[1].textContent.trim().split('\n').filter(s => s.trim());
                        const initiator = cells[2].textContent.trim();
                        const addressee = cells[3].textContent.trim().split('\n').filter(s => s.trim());
                        const dates = cells[4].textContent.trim().split('\n').filter(s => s.trim());

                        collectedData.push({
                            '–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞': docInfo[0] || '',
                            '–ù–∞–∑–≤–∞–Ω–∏–µ': docInfo[1] || '',
                            '–°—Ç–∞–¥–∏—è': stageInfo[0] || '',
                            '–°—Ç–∞—Ç—É—Å': stageInfo[1] || '',
                            '–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞': stageInfo[2] || '',
                            '–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä': initiator,
                            '–ê–¥—Ä–µ—Å–∞—Ç': addressee[0] || '',
                            '–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ': addressee[1] || '',
                            '–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞': dates[0] || '',
                            '–î–∞—Ç–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏': dates[1] || ''
                        });
                    }
                });

                updateProgress(page, lastPage);

                // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                if (page < lastPage) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ${page}:`, error);
                status.textContent = `–û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ${page}`;
            }
        }

        status.textContent = `–°–æ–±—Ä–∞–Ω–æ: ${collectedData.length} –∑–∞–ø–∏—Å–µ–π`;
        xlsxBtn.disabled = false;
        jsonBtn.disabled = false;
        collectBtn.disabled = false;
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ XLSX
    function downloadXLSX() {
        if (collectedData.length === 0) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏!');
            return;
        }

        const ws = XLSX.utils.json_to_sheet(collectedData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Contracts');

        const date = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `FSign_Contracts_${date}.xlsx`);
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ JSON
    function downloadJSON() {
        if (collectedData.length === 0) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏!');
            return;
        }

        const dataStr = JSON.stringify(collectedData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        const date = new Date().toISOString().split('T')[0];
        link.download = `FSign_Contracts_${date}.json`;
        link.click();
        URL.revokeObjectURL(url);
    }

    // –°–æ–±—ã—Ç–∏—è
    document.getElementById('fsign-collect').addEventListener('click', collectAllData);
    document.getElementById('fsign-xlsx').addEventListener('click', downloadXLSX);
    document.getElementById('fsign-json').addEventListener('click', downloadJSON);

})();
